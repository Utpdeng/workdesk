<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dil.glm.mapper.TbWeeklyManageMapper">

    <resultMap type="com.dil.glm.domain.weekly.TbWeeklyManage" id="TbWeeklyManageResult">
        <result property="id"    column="id"    />
        <result property="userId"    column="user_id"    />
        <result property="deptId"    column="dept_id"    />
        <result property="scopeWeek"    column="scope_week"    />
        <result property="nickName"    column="nick_name"    />
        <result property="context"    column="context"    />
        <result property="loguser"    column="loguser"    />
        <result property="logtime"    column="logtime"    />
    </resultMap>

    <sql id="selectTbWeeklyManageVo">
        select id, user_id, scope_week, context, loguser, logtime from tb_weekly_manage
    </sql>

    <select id="selectTbWeeklyManageList" parameterType="com.dil.glm.domain.weekly.TbWeeklyManage" resultMap="TbWeeklyManageResult">
        SELECT u.nick_name, a.id, u.user_id, a.scope_week, a.context, a.loguser, a.logtime,p.post_sort
        FROM sys_user u
                 LEFT JOIN (select id,user_id,scope_week,context,loguser,logtime from tb_weekly_manage where scope_week = #{scopeWeek}) a ON u.user_id = a.user_id
                 LEFT JOIN sys_dept d ON u.dept_id = d.dept_id
        left join sys_post p on p.post_id = (select post_id from sys_user_post u1 WHERE u.user_id = u1.user_id ORDER BY u1.post_id asc  LIMIT 1)
        where u.del_flag= '0' and u.user_id!=1
        <if test="deptId != null and deptId != 0">
            AND (d.dept_id IN ( SELECT dept_id FROM sys_dept WHERE dept_id = #{deptId} or find_in_set( #{deptId} , ancestors )))
        </if>
        <if test="nickName != null  and nickName != ''">
         and  u.nick_name like concat('%', #{nickName}, '%')</if>
        ORDER BY u.user_id <![CDATA[ <> ]]>  #{userId},post_sort
       <!-- ${params.dataScope} -->
    </select>

    <select id="selectTbWeeklyManageById" parameterType="Long" resultMap="TbWeeklyManageResult">
        <include refid="selectTbWeeklyManageVo"/>
        where id = #{id}
    </select>



</mapper>
